# Описание бизнес-логики в базе данных

Ниже перечислены все функции, процедуры, триггеры и представления, реализующие бизнес-логику в базе данных проекта. Формат описания соответствует образцу: имя: короткое назначение. Входные параметры, логика и результат.

1. Процедура `sp_подтвердить_закупку`: Процедура подтверждает поступление закупки материалов и обновляет остатки на складе. Входные параметры: `p_id_закупки INTEGER`. Логика: процедура проверяет текущий статус закупки в таблице `закупки_материалов`, и если закупка уже имеет статус `выполнено`, она бросает исключение; затем устанавливает статус закупки в `выполнено` и для каждой записи в `состав_закупки` увеличивает `количество_на_складе` соответствующего материала. Результат: статус закупки обновлён и остатки в таблице `материалы` скорректированы.

2. Процедура `sp_подтвердить_отгрузку`: Процедура помечает заказ как выполненный (готовый к отгрузке). Входные параметры: `p_id_заказа INTEGER`. Логика: процедура устанавливает поле `статус = 'выполнен'` в таблице `заказы` для указанного заказа. Результат: статус заказа изменён на `выполнен`.

3. Процедура `sp_взять_задачу_в_работу`: Процедура резервирует материалы под план производства и переводит задачу в статус "в_работе". Входные параметры: `p_id_плана INTEGER, p_id_сборщика INTEGER`. Логика: процедура считывает из `план_заготовок` `id_заготовки`, `плановое_количество` и текущий статус; если статус отличается от `'принято'`, она возвращает ошибку; для каждой позиции из `расход_материалов` проверяется, достаточно ли на складе (`материалы.количество_на_складе`) требуемого количества (количество_материала * плановое_количество), и если не хватает — бросается исключение с указанием наименования материала, требуемого и наличного количества; при успешной проверке процедура уменьшает `количество_на_складе` на требуемую величину для каждой позиции и устанавливает в `план_заготовок` `статус = 'в_работе'` и `id_сборщика = p_id_сборщика`. Результат: материалы списаны со склада и задача помечена как в работе; при недостатке материалов возвращается подробная ошибка.

4. Функция `sp_добавить_изделие_в_заказ`: Функция добавляет изделие в состав заказа, резервирует складские остатки или создаёт задания на производство при нехватке. Входные параметры: `p_id_заказа INTEGER, p_id_изделия INTEGER, p_количество INTEGER`. Логика: функция получает цену и текущий остаток по изделию в таблице `изделия`, добавляет запись в `состав_заказа` с фиксированной ценой (стоимость на момент добавления), затем если на складе достаточно — уменьшает `количество_на_складе`; если не хватает, переводит остаток в ноль, рассчитывает недостающее количество и для каждой позиции `состав_изделия` создаёт запись в `план_заготовок` на производство недостающих заготовок (умножая нормы на количество недостачи), устанавливая дату планирования как `дата_готовности` заказа минус один день и статус `принято`. Результат: функция возвращает строку с результатом — например, `'OK: ...'` при успешной резервации или `'WARNING: ...'` при создании заданий на производство.

5. Процедура `sp_сдать_работу`: Процедура обрабатывает сдачу выполненной работы по плану заготовок. Входные параметры: `p_id_плана INTEGER, p_колво_сдано INTEGER`. Логика: процедура считывает связанную `id_заготовки`, плановое и фактическое количество из `план_заготовок`, увеличивает `фактическое_количество` на переданное значение и увеличивает `количество_готовых` в таблице `заготовки`; если после операции фактическое количество становится больше или равно плановому, процедура устанавливает `статус = 'выполнено'` для соответствующего плана. Результат: фактические показатели обновлены и при достижении плана статус задания установлен как выполненный.

6. Процедура `sp_установить_статус_дня`: Процедура управляет графиком работы сотрудников, устанавливая статус дня. Входные параметры: `p_id_сотрудника INTEGER, p_дата DATE, p_статус VARCHAR`. Логика: процедура вставляет запись в `график_работы` или обновляет существующую запись (через `ON CONFLICT (id_сотрудника, дата) DO UPDATE`), перезаписывая статус на переданный. Результат: в таблице `график_работы` записан или обновлён статус на указанную дату.

7. Процедура `sp_отгрузить_заказ`: Процедура переводит статус заказа в `отгружен` после проверки корректности статуса. Входные параметры: `p_id_заказа INTEGER`. Логика: процедура сначала получает текущий `статус` заказа и если он отличается от `'выполнен'`, бросает исключение с пояснением; при корректном статусе обновляет `статус = 'отгружен'`. Результат: заказ помечается как `отгружен`, при неверном статусе возвращается ошибка.

8. Процедура `sp_закрыть_заказ`: Процедура закрывает заказ окончательно, переводя его в статус `завершен`. Входные параметры: `p_id_заказа INTEGER`. Логика: процедура проверяет, что текущий статус заказа равен `'отгружен'`, и в противном случае бросает исключение; при соответствии устанавливает `статус = 'завершен'`. Результат: заказ закрыт, при нарушении порядка статусов возвращается ошибка.

9. Представление `v_склад_общий`: Представление формирует унифицированный отчёт по остаткам склада. Входные параметры: отсутствуют. Логика: представление объединяет (`UNION ALL`) остатки из таблиц `материалы`, `заготовки` и `изделия`, помечая тип (`Материал`, `Заготовка`, `Изделие`) и приводя поля к единому набору (`артикул`, `наименование`, `количество`, `единица_измерения`). Результат: доступно представление с общим списком запасов.

10. Представление `v_заказы_менеджер`: Представление даёт отчёт для менеджера по заказам и их состоянию. Входные параметры: отсутствуют. Логика: выборка включает заказы с именами клиента и менеджера, датами, статусом, суммой, количество позиций в заказе и вычисляет состояние сроков по правилам (выполнен/отменен/просрочен/в норме). Результат: строки с ключевой информацией по заказам для менеджера.

11. Представление `v_задачи_сборщика`: Представление показывает задачи для сборщика по плану заготовок. Входные параметры: отсутствуют. Логика: объединяет информацию о планах из `план_заготовок` и наименованиях заготовок, включая плановое и фактическое количество, дедлайн, статус и ссылку на `id_сборщика`. Результат: удобная выборка задач для сборщика.

12. Представление `v_отчет_директора`: Представление предоставляет краткий отчёт для директора по выручке и расходам. Входные параметры: отсутствуют. Логика: суммирует выручку по выполненным заказам и расходы по выполненным закупкам (сумма `количество * цена_закупки` в `состав_закупки`). Результат: таблица с показателями типа "Выручка" и "Расходы".

13. Функция `trg_check_age_func()` и триггер `trg_check_age` на таблицу `сотрудники`: Функция и триггер проверяют совершеннолетие сотрудника при добавлении или обновлении. Входные параметры: (триггерная) `NEW` запись для таблицы `сотрудники`. Логика: при `INSERT` или `UPDATE` вычисляется возраст по полю `дата_рождения`, и если возраст меньше 18 лет, выбрасывается исключение с сообщением `Сотрудник должен быть совершеннолетним!`. Результат: предотвращается добавление или обновление записи сотрудника младше 18 лет.

14. Функция `trg_update_order_sum_func()` и триггер `trg_calc_sum` на таблицу `состав_заказа`: Функция и триггер обеспечивают автоматический пересчёт суммы заказа. Входные параметры: (триггерная) `OLD`/`NEW` записи таблицы `состав_заказа`. Логика: после `INSERT`/`UPDATE`/`DELETE` пересчитывается поле `сумма_заказа` в таблице `заказы` как сумма произведений `количество_изделий * цена_фиксированная` по всем позициям соответствующего заказа; при удалении используется `OLD.id_заказа`, при вставке/обновлении — `NEW.id_заказа`. Результат: поле `сумма_заказа` всегда отражает актуальную сумму по позициям заказа.


Примечания и замечания:
- В коде миграций встречается функция `sp_добавить_изделие_в_заказ`, реализованная как `FUNCTION` (возвращает `VARCHAR`), но по смыслу выполняет поведение процедуры (добавляет позиции и создаёт побочные задачи). В описании сохранено имя и поведение как в миграции.
- Процедуры, помеченные как "(приложение А, п. [номер])", содержат заполнители для нумерации пунктов приложения — при желании могу пронумеровать их по фактическому порядку вашего приложения.
- Если нужно, могу дополнительно сгенерировать список SQL-объектов с их сигнатурами (DDL), либо оформить ссылки на файлы миграций (`create_table.sql`, `create_logic.sql`, `assembler_logic.sql`, `fix_error_message.sql`, `manager_schedule.sql`, `status_logic.sql`).

